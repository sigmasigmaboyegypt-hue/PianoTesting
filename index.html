<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ultimate Piano Sequencer Finale</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.39/Tone.min.js"></script>
<style>
  body { font-family: 'Segoe UI', sans-serif; background: #1e1e2f; color: #fff; margin: 0; padding: 20px; }
  h1 { text-align: center; margin-bottom: 10px; }
  .controls { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
  select, button, input[type=range] { padding: 8px 15px; font-size: 16px; border-radius: 6px; border: none; cursor: pointer; }
  select { background: #2a2a40; color: #fff; }
  button { background: #56a0d3; color: #fff; transition: 0.2s; }
  button:hover { background: #3a78b1; }
  .slider { width: 120px; }
  .piano { display: flex; justify-content: center; margin-bottom: 10px; flex-wrap: wrap; }
  .key { width: 50px; height: 150px; border: 2px solid #444; border-radius: 6px; text-align: center; line-height: 150px; cursor: pointer; user-select: none; margin: 1px; background: linear-gradient(#eee,#ccc); color: #000; font-weight: bold; transition: 0.1s;}
  .key:active { background: #f5a623; }
  .timeline { position: relative; width: 100%; height: 320px; border: 2px solid #555; border-radius: 8px; display: grid; grid-template-rows: repeat(14, 1fr); grid-gap: 2px; background: #2a2a40; overflow-x: auto; }
  .timeline-row { position: relative; border-bottom: 1px solid #444; display:flex; align-items:center; }
  .note { position: absolute; height: 100%; background: #56a0d3; cursor: grab; border-radius: 4px; }
  .note.resizing { cursor: ew-resize; }
  .playhead { position: absolute; top: 0; width: 2px; height: 100%; background: #ff4c4c; z-index: 10; }
  .row-volume { margin-left: 5px; }
</style>
</head>
<body>

<h1>Ultimate Piano Sequencer Finale ðŸŽ¹</h1>

<div class="controls">
  <select id="styleSelector">
    <option value="classic">Classic Piano</option>
    <option value="lofi">Lofi Piano</option>
    <option value="electric">Electric Piano</option>
    <option value="synth">Synth Piano</option>
    <option value="jazz">Jazz Piano</option>
  </select>
  <label>Master Volume: <input type="range" id="masterVolume" min="-60" max="0" value="0" class="slider"></label>
  <button id="playBtn">Play Sequence</button>
</div>

<div class="piano" id="piano"></div>
<div class="timeline" id="timeline"></div>

<script>
const notes = ['C4','D4','E4','F4','G4','A4','B4','C5','D5','E5','F5','G5','A5','B5'];
const keyMap = { 'a':0,'s':1,'d':2,'f':3,'g':4,'h':5,'j':6,'k':7,'l':8,';':9, "'":10, 'z':11, 'x':12, 'c':13 };
const piano = document.getElementById('piano');
const timeline = document.getElementById('timeline');
const timelineRows = [];
const rowVolumes = [];
const masterVol = new Tone.Volume(0).toDestination();
let currentSynth = new Tone.Synth().connect(masterVol);

// Tone.js styles
const styleMap = {
  'classic': new Tone.Synth().connect(masterVol),
  'lofi': new Tone.FMSynth({harmonicity: 0.5, modulationIndex: 12, oscillator: {type: 'triangle'}}).connect(masterVol),
  'electric': new Tone.MembraneSynth().connect(masterVol),
  'synth': new Tone.AMSynth().connect(masterVol),
  'jazz': new Tone.MetalSynth({frequency: 200, envelope:{attack:0.01,decay:0.3,release:0.4},harmonicity:5,modulationIndex:30}).connect(masterVol)
};

// Create piano keys
notes.forEach((note,i)=>{
  const key = document.createElement('div');
  key.classList.add('key');
  key.textContent = note;
  key.addEventListener('click', ()=>addNote(i));
  piano.appendChild(key);
});

// Create timeline rows + volume sliders
notes.forEach((note,i)=>{
  const row = document.createElement('div');
  row.classList.add('timeline-row');
  timeline.appendChild(row);
  timelineRows.push(row);

  // Row volume slider
  const volSlider = document.createElement('input');
  volSlider.type='range';
  volSlider.min='-60';
  volSlider.max='0';
  volSlider.value='0';
  volSlider.classList.add('row-volume');
  volSlider.addEventListener('input',()=>{ rowVolumes[i].volume.value = volSlider.value; });
  row.appendChild(volSlider);

  const rowVol = new Tone.Volume(0).connect(masterVol);
  rowVolumes.push(rowVol);
});

// Add note
function addNote(rowIndex){
  const noteDiv = document.createElement('div');
  noteDiv.classList.add('note');
  noteDiv.style.left='0px';
  noteDiv.style.width='50px';
  noteDiv.dataset.noteIndex=rowIndex;
  timelineRows[rowIndex].appendChild(noteDiv);
  makeDraggableResizable(noteDiv,rowIndex);
}

// Keyboard support
document.addEventListener('keydown',(e)=>{
  const key = e.key.toLowerCase();
  if(keyMap[key]!==undefined){
    addNote(keyMap[key]);
  }
});

// Draggable/resizable
function makeDraggableResizable(noteDiv,rowIndex){
  let isDragging=false, isResizing=false, startX, startWidth;
  noteDiv.addEventListener('mousedown',(e)=>{
    const rect = noteDiv.getBoundingClientRect();
    if(e.offsetX>rect.width-10){ isResizing=true; startWidth=rect.width; startX=e.clientX; noteDiv.classList.add('resizing'); }
    else{ isDragging=true; startX=e.clientX-noteDiv.offsetLeft; }
  });
  document.addEventListener('mousemove',(e)=>{
    if(isDragging){ let newLeft=e.clientX-startX; if(newLeft<0)newLeft=0; noteDiv.style.left=newLeft+'px'; }
    if(isResizing){ let newWidth=startWidth+(e.clientX-startX); if(newWidth<20)newWidth=20; noteDiv.style.width=newWidth+'px'; }
  });
  document.addEventListener('mouseup',()=>{ isDragging=false; isResizing=false; noteDiv.classList.remove('resizing'); });
}

// Change instrument style
document.getElementById('styleSelector').addEventListener('change',(e)=>{
  currentSynth = styleMap[e.target.value];
});

// Master volume
document.getElementById('masterVolume').addEventListener('input',(e)=>{
  masterVol.volume.value = e.target.value;
});

// Play sequence
document.getElementById('playBtn').addEventListener('click', async ()=>{
  await Tone.start();
  const speed=200;
  const playhead=document.createElement('div');
  playhead.classList.add('playhead');
  timeline.appendChild(playhead);
  const timelineWidth=timeline.scrollWidth;
  const startTime=Tone.now();

  timelineRows.forEach((row,rowIndex)=>{
    Array.from(row.children).forEach(noteDiv=>{
      if(noteDiv.classList.contains('note')){
        const left=parseInt(noteDiv.style.left);
        const width=parseInt(noteDiv.style.width);
        const noteStart=startTime+(left/speed)*0.2;
        const noteDur=(width/speed)*0.2;
        currentSynth.connect(rowVolumes[rowIndex]);
        currentSynth.triggerAttackRelease(notes[rowIndex], noteDur, noteStart);
      }
    });
  });

  // Playhead animation
  playhead.style.left='0px';
  const startPerf=performance.now();
  function animate(){
    const elapsed=(performance.now()-startPerf)/1000;
    const px=elapsed*speed/0.2;
    if(px<timelineWidth){ playhead.style.left=px+'px'; requestAnimationFrame(animate); }
    else { timeline.removeChild(playhead); }
  }
  animate();
});
</script>

</body>
</html>
